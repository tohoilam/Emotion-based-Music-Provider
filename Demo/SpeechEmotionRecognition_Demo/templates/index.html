<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Speech Emotion Recognition Demo</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="../static/style.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery.min.js"></script>
  <script src="https://markjivko.com/dist/recorder.js"></script>
  <script>
    jQuery(document).ready(function () {

      listAudioData = []
      listSR = []

      var $ = jQuery;
      var myRecorder = {
        objects: {
          context: null,
          stream: null,
          recorder: null
        },
        init: function () {
          if (null === myRecorder.objects.context) {
            myRecorder.objects.context = new (
              window.AudioContext || window.webkitAudioContext
            );
          }
        },
        start: function () {
          var options = {audio: true, video: false};
          navigator.mediaDevices.getUserMedia(options).then(function (stream) {
            myRecorder.objects.stream = stream;
            myRecorder.objects.recorder = new Recorder(
              myRecorder.objects.context.createMediaStreamSource(stream),
              {numChannels: 1}
            );
            myRecorder.objects.recorder.record();
          }).catch(function (err) {});
        },
        stop: function (listObject, listAudioData, listSR) {
          if (null !== myRecorder.objects.stream) {
            myRecorder.objects.stream.getAudioTracks()[0].stop();
          }
          if (null !== myRecorder.objects.recorder) {
            myRecorder.objects.recorder.stop();

            // Validate object
            if (null !== listObject
                && 'object' === typeof listObject
                && listObject.length > 0) {
              // Export the WAV file
              myRecorder.objects.recorder.exportWAV((blob) => {
                var url = (window.URL || window.webkitURL)
                        .createObjectURL(blob);

                // Prepare the playback
                var audioObject = $('<audio controls></audio>')
                        .attr('src', url);

                // Prepare the download link
                var downloadObject = $('<a>&#9660;</a>')
                        .attr('href', url)
                        .attr('download', new Date().toUTCString() + '.wav');

                // Wrap everything in a row
                var holderObject = $('<div class="row"></div>')
                        .append(audioObject)
                        .append(downloadObject)
                        .append(getAudioObject);


                // Append to the list of audio to predict
                listObject.append(holderObject);

                // Bug: Can't load audio data after puttint it out to 
                try {
                  context = new AudioContext();
                  var audioBuffer = null;

                  var request = new XMLHttpRequest();
                  request.open('GET', url, true);
                  request.responseType = 'arraybuffer';

                  // Decode asynchronously
                  request.onload = () => {
                    context.decodeAudioData(request.response,
                      (buffer) => {
                        audioBuffer = buffer;
                        console.log("Duration: " + audioBuffer.duration)
                        console.log("Length: " + audioBuffer.length)
                        console.log("Channels: " + audioBuffer.numberOfChannels)
                        console.log("SR: " + audioBuffer.sampleRate)
                        console.log(audioBuffer.getChannelData(0))
                        console.log(audioBuffer)

                        listAudioData.push(audioBuffer.getChannelData(0))
                        listSR.push(audioBuffer.sampleRate)
                        
                      },
                      (err) => {
                        console.error(`Error with decoding audio data: ${err.err}`)
                      } 
                    );
                  }
                  request.send();
                }
                catch(e) {
                  alert('Web Audio API is not supported in this browser');
                }
              });
            }
          }
        }
      };

      // Prepare the recordings list
      var listObject = $('[data-role="recordings"]');

      // Prepare the record button
      $('[data-role="controls"] > button').click(() => {
        // Initialize the recorder
        myRecorder.init();

        // Get the button state 
        var buttonState = !!$(this).attr('data-recording');

        // Toggle
        if (!buttonState) {
          $(this).attr('data-recording', 'true');
          myRecorder.start();
        } else {
          $(this).attr('data-recording', '');
          myRecorder.stop(listObject, listAudioData, listSR);
        }
      });

      // Console Log Audio Data LIst
      $('[data-role="predict_emotion_button"]').click(() => {
        console.log(listAudioData)
        console.log(listSR)
      })
    });
  </script>
</head>
<body>
  <form action="{{ url_for('predict')}}" method="post">
    <input type="text" name="testing1" placeholder="testing1">
    <input type="text" name="testing2" placeholder="testing2">

    <button type="submit">Predict</button>
  </form>
  <h4>{{ prediction_text }}</h4>
  <div class="holder">
    <div data-role="controls">
      <button data-recording="">Record</button>
    </div>
    <div data-role="recordings"></div>
  </div>
  <button data-role="predict_emotion_button">Predict Emotion Button</button>
</body>
</html>